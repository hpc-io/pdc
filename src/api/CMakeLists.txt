#------------------------------------------------------------------------------
# Include source and build directories
#------------------------------------------------------------------------------
include_directories(
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_BINARY_DIR}
)

#------------------------------------------------------------------------------
# External dependencies
#------------------------------------------------------------------------------
# profiling
#set(PDC_EXT_LIB_DEPENDENCIES pdcprof ${PDC_EXT_LIB_DEPENDENCIES})
set(PDC_EXT_INCLUDE_DEPENDENCIES ${CMAKE_CURRENT_SOURCE_DIR}/profiling)
set(PDC_EXPORTED_LIBS pdcprof)

# Mercury
find_package(MERCURY REQUIRED)
if(MERCURY_FOUND)
  message(STATUS "mercury dir ${MERCURY_DIR}")
  set(PDC_EXT_INCLUDE_DEPENDENCIES ${MERCURY_INCLUDE_DIR}
    ${PDC_EXT_INCLUDE_DEPENDENCIES}
    )
  set(PDC_EXT_LIB_DEPENDENCIES mercury ${PDC_EXT_LIB_DEPENDENCIES})
endif()

include_directories(${PDC_EXT_INCLUDE_DEPENDENCIES})

#------------------------------------------------------------------------------
# Configure module header files
#------------------------------------------------------------------------------
# Set unique vars used in the autogenerated config file (symbol import/export)
if(BUILD_SHARED_LIBS)
  set(PDC_BUILD_SHARED_LIBS 1)
  set(PDC_LIBTYPE SHARED)
else()
  set(PDC_BUILD_SHARED_LIBS 0)
  set(PDC_LIBTYPE STATIC)
endif()

configure_file(
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_config.h.in
  ${CMAKE_CURRENT_BINARY_DIR}/pdc_config.h
)

#------------------------------------------------------------------------------
# Set sources
#------------------------------------------------------------------------------
set(PDC_SRCS
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_malloc.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_prop.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_cont.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_obj.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_analysis_and_transforms_connect.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_analysis_common.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_analysis.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_client_connect.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_client_server_common.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_hist_pkg.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_interface.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_mpi.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_query.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_region.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_region_cache.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_transform.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_transforms_common.c
  )

  add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/profiling)

#------------------------------------------------------------------------------
# Libraries
#------------------------------------------------------------------------------
# PDC
set(PDC_BUILD_INCLUDE_DEPENDENCIES
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_BINARY_DIR}
)

add_library(pdc ${PDC_SRCS})

target_include_directories(pdc
  PUBLIC  "$<BUILD_INTERFACE:${PDC_BUILD_INCLUDE_DEPENDENCIES}>"
          $<INSTALL_INTERFACE:${PDC_INSTALL_INCLUDE_INTERFACE}>
)

target_link_libraries(pdc
  ${PDC_EXPORTED_LIBS}
  ${PDC_EXT_LIB_DEPENDENCIES}
  -ldl
)
pdc_set_lib_options(pdc "pdc" ${PDC_LIBTYPE})

set(PDC_EXPORTED_LIBS pdc ${PDC_EXPORTED_LIBS})

#-----------------------------------------------------------------------------
# Specify project header files to be installed
#-----------------------------------------------------------------------------
set(PDC_HEADERS
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_analysis.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_timing.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_cont.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_mpi.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_obj.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_region_cache.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_region.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_prop.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_public.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_query.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_region.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_transform.h
  ${CMAKE_BINARY_DIR}/pdc_config.h
  )

#-----------------------------------------------------------------------------
# Add file(s) to CMake Install
#-----------------------------------------------------------------------------
install(
  FILES
    ${PDC_HEADERS}
  DESTINATION
    ${PDC_INSTALL_INCLUDE_DIR}
  COMPONENT
    headers
)

install(
  FILES
    ${PDC_HL_HEADERS}
  DESTINATION
    ${PDC_INSTALL_INCLUDE_DIR}
  COMPONENT
    headers
)

#-----------------------------------------------------------------------------
# Add Target(s) to CMake Install
#-----------------------------------------------------------------------------
install(
  TARGETS
    pdc
  EXPORT
    ${PDC_EXPORTED_TARGETS}
  LIBRARY DESTINATION ${PDC_INSTALL_LIB_DIR}
  ARCHIVE DESTINATION ${PDC_INSTALL_LIB_DIR}
  RUNTIME DESTINATION ${PDC_INSTALL_BIN_DIR}
)

#-----------------------------------------------------------------------------
# Add Target(s) to CMake Install for import into other projects
#-----------------------------------------------------------------------------
install(
  EXPORT
    ${PDC_EXPORTED_TARGETS}
  DESTINATION
    ${PDC_INSTALL_DATA_DIR}/cmake/pdc
  FILE
    ${PDC_EXPORTED_TARGETS}.cmake
)

#-----------------------------------------------------------------------------
# Export all exported targets to the build tree for use by parent project
#-----------------------------------------------------------------------------
if(NOT PDC_EXTERNALLY_CONFIGURED)
EXPORT (
  TARGETS
    ${PDC_EXPORTED_LIBS}
  FILE
    ${PDC_EXPORTED_TARGETS}.cmake
)
endif()

#------------------------------------------------------------------------------
# Set variables for parent scope
#------------------------------------------------------------------------------
# Used by config.cmake.build.in and Testing
set(PDC_INCLUDES_BUILD_TIME
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_BINARY_DIR}
  ${PDC_EXT_INCLUDE_DEPENDENCIES}
  PARENT_SCOPE
)

# Used by config.cmake.install.in
set(PDC_INCLUDES_INSTALL_TIME
  ${PDC_INSTALL_INCLUDE_DIR}
  ${PDC_EXT_INCLUDE_DEPENDENCIES}
  PARENT_SCOPE
)
